<!DOCTYPE html>
<html>

<head>
    <title>DemoDojo Screen Recorder - Offscreen Document</title>
</head>

<body>
    <script type="module">
        import Recorder from './lib/recorder.ts'
        import {
            START_RECORDING,
            START_RECORDING_OFFSCREEN,
            STOP_RECORDING,
            RECORDING_COMPLETED,
            RECORDING_STARTED
        } from './lib/messages.ts';

        const recorder = new Recorder()
        let mediaRecorder = null;
        let recordedChunks = [];

        chrome.runtime.onMessage.addListener(async (message) => {
            if (message.target !== 'offscreen') return;

            if (message.type === START_RECORDING && message.data) {
                const { streamId, width, height, audio, recordingMode } = message.data;
                console.log("offscreen starting recording", streamId, width, height, audio, recordingMode)
                recorder.start({
                    streamId,
                    width,
                    height,
                    audio,
                    recordingMode,
                }, (url) => {
                    chrome.runtime.sendMessage({
                        type: RECORDING_COMPLETED,
                        videoUrl: url
                    });
                });

                const media = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        mandatory: {
                            chromeMediaSource: "tab",
                            chromeMediaSourceId: streamId,
                        },
                    },
                    video: {
                        mandatory: {
                            chromeMediaSource: "tab",
                            chromeMediaSourceId: streamId,
                        },
                    },
                })

                mediaRecorder = new MediaRecorder(media, {
                    mimeType: 'video/webm;codecs=vp9'
                });

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };


                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    chrome.runtime.sendMessage({
                        type: RECORDING_COMPLETED,
                        videoUrl: url
                    });
                    recordedChunks = [];
                };
                mediaRecorder.start();
                chrome.runtime.sendMessage({ type: RECORDING_STARTED });
            }
            if (message.type === START_RECORDING_OFFSCREEN) {
                console.log('[DemoDojo] Offscreen document received start recording message:', message.data);

                // Initialize the recorder
                recorder = new Recorder();
                recorder.start(message.data, (url) => {
                    console.log('[DemoDojo] Recording completed, video URL:', url);

                    // Notify the background service worker
                    chrome.runtime.sendMessage({
                        type: RECORDING_COMPLETED,
                        videoUrl: url,
                    });
                });
            }

            if (message.type === STOP_RECORDING && mediaRecorder) {
                mediaRecorder.stop()
                if (mediaRecorder?.stream) {
                    mediaRecorder.stream.getTracks().forEach(track => track.stop());
                }

            }
        });
    </script>
</body>

</html>